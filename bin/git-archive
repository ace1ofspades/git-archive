#!/usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [[ -n "$GIT_ARCHIVE_LIB" && -f "$GIT_ARCHIVE_LIB/common.sh" ]]; then
  LIB_DIR="$GIT_ARCHIVE_LIB"

elif [[ -f "$SCRIPT_DIR/../lib/common.sh" ]]; then
  # local repo usage
  LIB_DIR="$SCRIPT_DIR/../lib"

elif [[ -f "$SCRIPT_DIR/../libexec/common.sh" ]]; then
  # Homebrew Cellar layout
  LIB_DIR="$SCRIPT_DIR/../libexec"

elif [[ -f "/opt/homebrew/opt/git-archive/libexec/common.sh" ]]; then
  # Homebrew opt prefix (stable)
  LIB_DIR="/opt/homebrew/opt/git-archive/libexec"

else
  echo "âŒ Cannot locate git-archive lib directory" >&2
  exit 1
fi

source "$LIB_DIR/common.sh"
source "$LIB_DIR/archive.sh"
source "$LIB_DIR/extract.sh"

if [[ "$1" == "--version" ]]; then
  echo "git-archive 0.2.2"
  exit 0
fi

CMD="archive"
if [[ "$1" == "extract" ]]; then
  CMD="extract"
  shift
fi

case "$CMD" in
  archive) run_archive "$@" ;;
  extract) run_extract "$@" ;;
  *) usage; exit 64 ;;
esac
